lang = "en";
landCode = (lang === "en") ? "en-US" : "zh-CN";
fs = require('fs');
_ = require('underscore');
dicts = require('../../assets/lang/' + lang + '/htmlTStr.js');

var tutorMap = {
    "datastoreTut1.html"        : "datastoreTut1",
    "datastoreTut1DemoMode.html": "datastoreTut1Demo",
    "datastoreTut2.html"        : "datastoreTut2",
    "workbookTut.html"          : "workbookTut"
};

function genHTML(srcDir, destMap) {
    files = fs.readdirSync(srcDir);
    for (var i = 0, len = files.length; i < len; i++) {
        genHTMLHelper(files[i], srcDir, destMap);
    }
}

function genHTMLHelper(file, srcDir, destMap) {
    if (!destMap.hasOwnProperty(file)) {
        console.error(file, "has not dest");
        return;
    }

    var dest = destMap[file];
    var path = srcDir + '/' + file;
    var html = fs.readFileSync(path).toString();
    var template = _.template(html);

    if (typeof dest === "string") {
        if (tutorMap.hasOwnProperty(file)) {
            dicts.isTutor = true;
            // it should be found in html_en's tutor obj
            var tutorName = tutorMap[file];
            // overwrite the dicts.tutor[tutorName] to dicts.tutor.meta,
            // so all walkthough.html can just use dicts.tutor.meta
            // to find the string that needed
            dicts.tutor.meta = dicts.tutor[tutorName];
            dicts.tutor.name = tutorName;
        } else {
            dicts.isTutor = false;
            dicts.tutor.name = "";

            if (file === "unitTest.html" ||
                file === "unitTestInstaller.html") {
                dicts.isUnitTest = true;
            } else {
                dicts.isUnitTest = null;
            }

            dicts.isTarballInstaller = true;
        }
        var parsedHTML = template(dicts);
        // comment starats with ! will not be removed by grunt htmlmin
        parsedHTML = "<!--!This file is autogenerated. Please do not modify-->\n" +
                     parsedHTML;
        fs.writeFileSync(dest, parsedHTML);
    } else {
        for (var i = 0; i < dest.length; i++) {
            if (dest[i] === "install-tarball.html") {
                dicts.isTarballInstaller = true;
            } else {
                dicts.isTarballInstaller = null;
            }
            var parsedHTML = template(dicts);
            // comment starats with ! will not be removed by grunt htmlmin
            parsedHTML = "<!--!This file is autogenerated. Please do not modify-->\n" +
                         parsedHTML;
            fs.writeFileSync(dest[i], parsedHTML);
        }
    }
}

module.exports = genHTML;
