fs = require('fs');
_ = require('underscore');

var src = "site/render/template/constructor.template.js";
var curCtorDest = "assets/js/constructor/E_persConstructor.js";
var currentVersion = 2;

function genCtor(isCurrentConstructor) {
    var dest, version;
    if (isCurrentConstructor) {
        version = null;
        dest = curCtorDest;
    } else {
        version = currentVersion;
        dest = genDest(currentVersion);
    }

    var str = fs.readFileSync(src).toString();
    var template = _.template(str);
    var parsedStr = template({
        "version": version,
        "isCurCtor": isCurrentConstructor
    });
    // comment starats with ! will not be removed by grunt htmlmin
    parsedStr = "/* !!This file is autogenerated. Please do not modify */\n" +
                 parsedStr.trim() + "\n";
    fs.writeFileSync(dest, parsedStr);
    console.log("generate", dest);
}

function genDest(version) {
    if (version > 26) {
        throw "version too large";
    }
    var str = "ABCDEFGHIJKLMNOPQRETUVWXYZ";
    var ch = (version < 2) ? "" : str[version - 1];
    return "assets/js/constructor/D" + ch +
           "_persConstructorV" + version + ".js";
}

module.exports = genCtor;
